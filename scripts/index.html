<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã€ŠæŸ“ãƒ»é’Ÿæ¥¼è°œå›¢ã€‹å‰§æœ¬æŸ¥çœ‹å™¨</title>

    <!-- Favicons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <link rel="manifest" href="/favicons/site.webmanifest">
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Hiragino Sans GB',
          'Microsoft YaHei', sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        font-size: 1.25em;
        color: #333;
        text-align: center;
        margin-top: 0;
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }

      .file-input {
        border: 2px dashed #ddd;
        min-height: 60px;
        padding: 5px 20px;
        text-align: center;
        cursor: pointer;
      }
      .file-input:hover {
        border-color: #007bff;
      }
      .file-input.dragover {
        border-color: #007bff;
        background-color: #f8f9fa;
      }
      .file-summary {
        padding: 5px 20px;
        background: #e8f5e8;
        border: 2px solid #4caf50;
        border-radius: 4px;
        min-height: 60px;
        display: flex;
        align-items: center;
      }
      .summary-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .remove-btn {
        background: #f44336;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        width: auto;
        margin: 0;
      }
      .remove-btn:hover {
        background: #d32f2f;
      }
      button {
        background: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        margin-top: 10px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #2d2d2d55;
        border-radius: 4px;
        display: none;
      }
      .result.error {
        border: 1px solid #87231c;
      }
      .link-container {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .link-container input {
        flex: 1;
      }
      .copy-btn {
        width: auto;
        margin: 0;
        padding: 10px 15px;
      }

      .row {
        display: flex;
        gap: 15px;
      }
      .row .form-group {
        flex: 1;
      }

      .preset-section {
        margin-bottom: 30px;
        padding: 8px 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e9ecef;
      }

      .preset-section h2 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #495057;
        font-size: 1.2em;
      }

      .preset-section p {
        margin-bottom: 15px;
        color: #6c757d;
      }

      .preset-section a {
        color: #007bff;
        text-decoration: none;
      }

      .preset-section a:hover {
        text-decoration: underline;
      }

      .preset-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 10px;
      }

      .preset-btn {
        background: #ffffff;
        color: #333;
        padding: 5px 8px;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        text-align: left;
        width: 100%;
        margin: 0;
      }

      .preset-btn:hover {
        background: #f8f9fa;
        border-color: #007bff;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .preset-btn .name {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
      }

      .preset-btn .details {
        font-size: 12px;
        opacity: 0.9;
        display: block;
      }

      .divider {
        text-align: center;
        margin: 15px 0px;
        height: 1px;
        position: relative;
      }

      .divider::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #dee2e6;
      }

      .theme-toggle {
        position: fixed;
        top: 10px;
        right: 10px;
        width: 50px;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        z-index: 1000;
      }
      .theme-toggle::before {
        content: 'ğŸŒ™';
      }
      .theme-toggle:hover {
        background: #e0e0e0;
      }
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #1a1a1a;
          color: #e0e0e0;
        }
        .container {
          background: #2d2d2d;
          color: #e0e0e0;
        }
        h1 {
          color: #e0e0e0;
        }
        label {
          color: #ccc;
        }
        input,
        textarea,
        select {
          background: #3d3d3d;
          border-color: #555;
          color: #e0e0e0;
        }
        .file-input {
          border-color: #555;
          background: #3d3d3d;
        }
        .file-input:hover {
          border-color: #007bff;
        }
        .file-input.dragover {
          background-color: #4d4d4d;
        }
        .file-summary {
          background: #2d4a2d;
          border-color: #4caf50;
        }

        .preset-section {
          background: #3d3d3d;
          border-color: #555;
        }

        .preset-section h2 {
          color: #e0e0e0;
        }

        .preset-section p {
          color: #ccc;
        }

        .preset-section a {
          color: #66b3ff;
        }

        .divider::before {
          background: #555;
        }

        .divider span {
          background: #2d2d2d;
          color: #ccc;
        }

        .preset-btn {
          background: #3d3d3d;
          color: #e0e0e0;
          border-color: #555;
        }

        .preset-btn:hover {
          background: #4d4d4d;
          border-color: #66b3ff;
        }

        .theme-toggle {
          background: #333;
          color: #e0e0e0;
          border-color: #555;
        }
        .theme-toggle::before {
          content: 'â˜€ï¸';
        }
        .theme-toggle:hover {
          background: #444;
        }
      }
      body.revert {
        background-color: #f5f5f5;
        color: black;
      }
      body.revert .container {
        background: white;
        color: black;
      }
      body.revert h1 {
        color: #333;
      }
      body.revert label {
        color: #555;
      }
      body.revert input,
      body.revert textarea,
      body.revert select {
        background: white;
        border-color: #ddd;
        color: black;
      }
      body.revert .file-input {
        border-color: #ddd;
        background: white;
      }
      body.revert .file-input.dragover {
        background-color: #f8f9fa;
      }
      body.revert .file-summary {
        background: #e8f5e8;
        border-color: #4caf50;
      }

      body.revert .theme-toggle {
        background: #f0f0f0;
        color: black;
        border-color: #ccc;
      }
      body.revert .theme-toggle::before {
        content: 'ğŸŒ™';
      }
      body.revert .theme-toggle:hover {
        background: #e0e0e0;
      }

      body.revert .preset-section {
        background: #f8f9fa;
        border-color: #e9ecef;
      }

      body.revert .preset-section h2 {
        color: #495057;
      }

      body.revert .preset-section p {
        color: #6c757d;
      }

      body.revert .preset-section a {
        color: #007bff;
      }

      body.revert .preset-btn {
        background: #ffffff;
        color: #333;
        border-color: #dee2e6;
      }

      body.revert .preset-btn:hover {
        background: #f8f9fa;
        border-color: #007bff;
      }

      body.revert .divider::before {
        background: #dee2e6;
      }

      body.revert .divider span {
        background: white;
        color: #6c757d;
      }
      .footer {
        margin-top: 2em;
        padding-top: 1em;
        border-top: 1px solid #ccc;
        font-size: 0.8em;
        color: #666;
      }
      a {
        color: #0696d3;
        text-decoration: none;
      }
      a:visited {
        color: #0696d3;
      }
      a:hover {
        text-decoration: underline;
      }
      @media (prefers-color-scheme: dark) {
        .footer {
          border-top-color: #444;
          color: #999;
        }
      }
      body.revert .footer {
        border-top-color: #ccc;
        color: #666;
      }
    </style>
  </head>
  <body>
    <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜"></button>
    <div class="container">
      <h1>ã€ŠæŸ“ãƒ»é’Ÿæ¥¼è°œå›¢ã€‹å‰§æœ¬æŸ¥çœ‹å™¨</h1>
      <p>
        æ¨èå‰å¾€
        <a href="https://clocktower.gstonegames.com/script_tool/" target="_blank">å®˜æ–¹å‰§æœ¬å·¥å…·</a>
        ç”Ÿæˆè‡ªå®šä¹‰å‰§æœ¬ï¼Œæˆ–ä½¿ç”¨ä»¥ä¸‹é¢„è®¾ï¼š
      </p>
      <div class="preset-section">
        <h2>ä½¿ç”¨é¢„è®¾å‰§æœ¬</h2>
        <div class="preset-buttons" id="presetButtons">
          <!-- Preset buttons will be generated here -->
        </div>
      </div>

      <div class="divider"></div>

      <form id="scriptForm">
        <div class="form-group">
          <label for="jsonFile">ä¸Šä¼  JSON æ–‡ä»¶</label>
          <div class="file-input" id="fileInput">
            <input type="file" id="jsonFile" accept=".json" style="display: none" />
            <p>ç‚¹å‡»æ­¤å¤„æˆ–æ‹–æ‹½ JSON æ–‡ä»¶åˆ°è¿™é‡Œ</p>
          </div>
          <div class="file-summary" id="fileSummary" style="display: none">
            <div class="summary-content">
              <span id="summaryText"></span>
              <button type="button" class="remove-btn" onclick="clearData()">ç§»é™¤</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="scriptName">å‰§æœ¬åç§°</label>
            <input type="text" id="scriptName" placeholder="è¾“å…¥å‰§æœ¬åç§°" />
          </div>
          <div class="form-group">
            <label for="author">ä½œè€…</label>
            <input type="text" id="author" placeholder="è¾“å…¥ä½œè€…åç§°" />
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="difficulty">éš¾åº¦</label>
            <select id="difficulty">
              <option value="">é€‰æ‹©éš¾åº¦</option>
              <option value="1">1 - â˜…â˜†â˜†â˜†â˜†</option>
              <option value="2">2 - â˜…â˜…â˜†â˜†â˜†</option>
              <option value="3">3 - â˜…â˜…â˜…â˜†â˜†</option>
              <option value="4">4 - â˜…â˜…â˜…â˜…â˜†</option>
              <option value="5">5 - â˜…â˜…â˜…â˜…â˜…</option>
            </select>
          </div>
          <div class="form-group">
            <label for="minPlayers">æœ€å°‘äººæ•°</label>
            <input type="number" id="minPlayers" min="5" max="20" placeholder="5" />
          </div>
          <div class="form-group">
            <label for="maxPlayers">æœ€å¤šäººæ•°</label>
            <input type="number" id="maxPlayers" min="5" max="20" placeholder="15" />
          </div>
        </div>

        <button type="submit">ç”Ÿæˆå‰§æœ¬é“¾æ¥</button>
      </form>

      <div id="result" class="result">
        <b>å‰§æœ¬é“¾æ¥ï¼š</b>
        <div class="link-container">
          <input type="text" id="generatedLink" readonly />
          <button type="button" class="copy-btn" onclick="copyLink()">å¤åˆ¶</button>
          <button type="button" class="copy-btn" onclick="openLink()">æ‰“å¼€</button>
        </div>
      </div>
    </div>
    <div class="footer">
      <p>
        ç‰ˆæƒæ‰€æœ‰
        <a href="https://bloodontheclocktower.com/" target="_blank">The Pandemonium Institute</a> å’Œ
        <a href="https://clocktower.gstonegames.com/" target="_blank">é›†çŸ³</a>
      </p>
      <p>æœ¬é¡µé¢ç”±ç¬¬ä¸‰æ–¹å·¥å…·"é’Ÿå°æ¥¼"ç”Ÿæˆ</p>
    </div>

    <script>
      const fileInput = document.getElementById('jsonFile');
      const fileInputDiv = document.getElementById('fileInput');
      const result = document.getElementById('result');
      const generatedLink = document.getElementById('generatedLink');

      let currentScriptData = null;

      // Preset scripts data
      const presetScripts = [
        {
          name: 'æš—æµæ¶ŒåŠ¨',
          level: 1,
          author: 'The Pandemonium Institute',
          roles: [
            { id: 'washerwoman' },
            { id: 'librarian' },
            { id: 'investigator' },
            { id: 'chef' },
            { id: 'empath' },
            { id: 'fortune_teller' },
            { id: 'undertaker' },
            { id: 'monk' },
            { id: 'ravenkeeper' },
            { id: 'virgin' },
            { id: 'slayer' },
            { id: 'soldier' },
            { id: 'mayor' },
            { id: 'butler' },
            { id: 'drunk' },
            { id: 'recluse' },
            { id: 'saint' },
            { id: 'poisoner' },
            { id: 'spy' },
            { id: 'scarlet_woman' },
            { id: 'baron' },
            { id: 'imp' },
            { id: 'beggar' },
            { id: 'scapegoat' },
            { id: 'gunslinger' },
            { id: 'thief' },
            { id: 'bureaucrat' },
          ],
          min_player: 5,
          max_player: 15,
        },
        {
          name: 'é»¯æœˆåˆå‡',
          level: 3,
          author: 'The Pandemonium Institute',
          roles: [
            { id: 'grandmother' },
            { id: 'sailor' },
            { id: 'chambermaid' },
            { id: 'exorcist' },
            { id: 'innkeeper' },
            { id: 'gambler' },
            { id: 'gossip' },
            { id: 'courtier' },
            { id: 'professor' },
            { id: 'minstrel' },
            { id: 'tea_lady' },
            { id: 'pacifist' },
            { id: 'fool' },
            { id: 'tinker' },
            { id: 'moonchild' },
            { id: 'goon' },
            { id: 'lunatic' },
            { id: 'godfather' },
            { id: 'devils_advocate' },
            { id: 'assassin' },
            { id: 'mastermind' },
            { id: 'zombuul' },
            { id: 'pukka' },
            { id: 'shabaloth' },
            { id: 'po' },
            { id: 'voudon' },
            { id: 'bishop' },
            { id: 'judge' },
            { id: 'matron' },
            { id: 'apprentice' },
          ],
          min_player: 7,
          max_player: 15,
        },
        {
          name: 'æ¢¦æ®’æ˜¥å®µ',
          level: 3,
          author: 'The Pandemonium Institute',
          roles: [
            { id: 'clockmaker' },
            { id: 'dreamer' },
            { id: 'snake_charmer' },
            { id: 'mathematician' },
            { id: 'flowergirl' },
            { id: 'town_crier' },
            { id: 'oracle' },
            { id: 'savant' },
            { id: 'seamstress' },
            { id: 'philosopher' },
            { id: 'artist' },
            { id: 'juggler' },
            { id: 'sage' },
            { id: 'mutant' },
            { id: 'sweetheart' },
            { id: 'barber' },
            { id: 'klutz' },
            { id: 'evil_twin' },
            { id: 'witch' },
            { id: 'cerenovus' },
            { id: 'pit-hag' },
            { id: 'fang_gu' },
            { id: 'vigormortis' },
            { id: 'no_dashii' },
            { id: 'vortox' },
            { id: 'deviant' },
            { id: 'bone_collector' },
            { id: 'butcher' },
            { id: 'harlot' },
            { id: 'barista' },
          ],
          min_player: 7,
          max_player: 15,
        },
        {
          name: 'æ— ä¸Šæ„‰æ‚¦',
          level: 1,
          author: 'Steven Medway',
          roles: [
            'investigator',
            'clockmaker',
            'empath',
            'chambermaid',
            'artist',
            'sage',
            'drunk',
            'klutz',
            'scarletwoman',
            'baron',
            'imp',
          ],
          min_player: 5,
          max_player: 6,
        },
        {
          name: 'çªƒçªƒç§è¯­',
          level: 4,
          author: 'Steven Medway',
          roles: [
            'balloonist',
            'savant',
            'artist',
            'fisherman',
            'cannibal',
            'amnesiac',
            'lunatic',
            'mutant',
            'widow',
            'goblin',
            'leviathan',
          ],
          min_player: 5,
          max_player: 6,
        },
      ];

      // Generate preset buttons
      function generatePresetButtons() {
        const presetButtonsContainer = document.getElementById('presetButtons');
        presetButtonsContainer.innerHTML = '';

        presetScripts.forEach((preset, index) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'preset-btn';
          button.onclick = () => selectPreset(index);

          const stars = 'â˜…'.repeat(preset.level) + 'â˜†'.repeat(5 - preset.level);

          button.innerHTML = `
            <span class="name">${preset.name}</span>
            <span class="details">${preset.author}</span>
            <span class="details">${stars} | ${preset.min_player}-${preset.max_player}äºº</span>
          `;

          presetButtonsContainer.appendChild(button);
        });
      }

      // Handle preset selection
      function selectPreset(index) {
        const preset = presetScripts[index];

        // Normalize roles format - convert string IDs to objects if needed
        const normalizedRoles = preset.roles.map((role) => {
          if (typeof role === 'string') {
            return { id: role };
          }
          return role;
        });

        // Set current script data
        currentScriptData = {
          name: preset.name,
          author: preset.author,
          level: preset.level,
          min_player: preset.min_player,
          max_player: preset.max_player,
          roles: normalizedRoles,
        };

        // Update form fields
        document.getElementById('scriptName').value = preset.name;
        document.getElementById('author').value = preset.author;
        document.getElementById('difficulty').value = preset.level.toString();
        document.getElementById('minPlayers').value = preset.min_player.toString();
        document.getElementById('maxPlayers').value = preset.max_player.toString();

        // Show summary
        updateFileSummary(`é¢„è®¾å‰§æœ¬: ${preset.name} (${preset.roles.length} ä¸ªè§’è‰²)`);

        // Generate link immediately
        generateLink();
      }

      // Initialize preset buttons when page loads
      document.addEventListener('DOMContentLoaded', () => {
        generatePresetButtons();
      });

      // File input handling
      fileInputDiv.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', handleFileSelect);

      // Drag and drop handling
      fileInputDiv.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileInputDiv.classList.add('dragover');
      });

      fileInputDiv.addEventListener('dragleave', () => {
        fileInputDiv.classList.remove('dragover');
      });

      fileInputDiv.addEventListener('drop', (e) => {
        e.preventDefault();
        fileInputDiv.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      // Clipboard handling for JSON content
      document.addEventListener('paste', (e) => {
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData('text');

        if (pastedData.trim()) {
          try {
            const parsed = JSON.parse(pastedData);
            handleJsonData(parsed);
            e.preventDefault(); // Prevent default paste behavior
          } catch (error) {
            // Not valid JSON, ignore
          }
        }
      });

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      }

      function handleFile(file) {
        if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
          showError('è¯·é€‰æ‹© JSON æ–‡ä»¶');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const content = e.target.result;
            const parsed = JSON.parse(content);
            handleJsonData(parsed, file.name);
          } catch (error) {
            showError('æ— æ•ˆçš„ JSON æ–‡ä»¶ï¼š' + error.message);
          }
        };
        reader.readAsText(file);
      }

      function handleJsonData(parsed, fileName = null) {
        // Check if parsed data is an array (roles only)
        if (Array.isArray(parsed)) {
          currentScriptData = {
            name: fileName ? fileName.replace(/\.[^/.]+$/, '') : '', // Remove file extension
            roles: parsed,
          };
        } else {
          currentScriptData = parsed;
        }

        // Extract _meta object if present and use its information
        let metaObject = null;
        if (currentScriptData.roles && Array.isArray(currentScriptData.roles)) {
          metaObject = currentScriptData.roles.find(role => role.id === '_meta');
        }

        // Auto-fill form fields, preferring meta object values
        const scriptName = metaObject?.name || currentScriptData.name;
        const scriptAuthor = metaObject?.author || currentScriptData.author;

        if (scriptName)
          document.getElementById('scriptName').value = scriptName;
        if (scriptAuthor)
          document.getElementById('author').value = scriptAuthor;
        if (currentScriptData.level)
          document.getElementById('difficulty').value = currentScriptData.level;
        if (currentScriptData.min_player)
          document.getElementById('minPlayers').value = currentScriptData.min_player;
        if (currentScriptData.max_player)
          document.getElementById('maxPlayers').value = currentScriptData.max_player;

        // Show summary and hide file input
        showFileSummary();

        // Clear any previous errors
        result.style.display = 'none';
      }

      function showFileSummary() {
        const fileInput = document.getElementById('fileInput');
        const fileSummary = document.getElementById('fileSummary');
        const summaryText = document.getElementById('summaryText');

        if (currentScriptData && currentScriptData.roles) {
          const actualRoles = currentScriptData.roles.filter(role => role.id !== '_meta');
          const roleCount = actualRoles.length;
          summaryText.textContent = `å·²åŠ è½½ ${roleCount} ä¸ªè§’è‰²`;

          fileInput.style.display = 'none';
          fileSummary.style.display = 'block';
        }
      }

      function updateFileSummary(text) {
        const fileInput = document.getElementById('fileInput');
        const fileSummary = document.getElementById('fileSummary');
        const summaryText = document.getElementById('summaryText');

        summaryText.textContent = text;
        fileInput.style.display = 'none';
        fileSummary.style.display = 'block';
      }

      function clearData() {
        currentScriptData = null;

        // Clear form fields
        document.getElementById('scriptName').value = '';
        document.getElementById('author').value = '';
        document.getElementById('difficulty').value = '';
        document.getElementById('minPlayers').value = '';
        document.getElementById('maxPlayers').value = '';

        // Reset file input
        document.getElementById('jsonFile').value = '';

        // Show file input, hide summary
        document.getElementById('fileInput').style.display = 'block';
        document.getElementById('fileSummary').style.display = 'none';

        // Clear any results
        result.style.display = 'none';
      }

      document.getElementById('scriptForm').addEventListener('submit', (e) => {
        e.preventDefault();
        generateLink();
      });

      async function generateLink() {
        try {
          let scriptData;

          // Check if we have script data from file/clipboard
          if (!currentScriptData) {
            showError('è¯·å…ˆä¸Šä¼  JSON æ–‡ä»¶æˆ–ç²˜è´´ JSON å†…å®¹');
            return;
          }

          // Use the current script data
          scriptData = { ...currentScriptData };

          // Filter out _meta objects from roles before sending to backend
          if (scriptData.roles && Array.isArray(scriptData.roles)) {
            scriptData.roles = scriptData.roles.filter(role => role.id !== '_meta');
          }

          // Override with form values if provided
          const name = document.getElementById('scriptName').value.trim();
          const author = document.getElementById('author').value.trim();
          const difficulty = document.getElementById('difficulty').value;
          const minPlayers = document.getElementById('minPlayers').value;
          const maxPlayers = document.getElementById('maxPlayers').value;

          if (name) scriptData.name = name;
          if (author) scriptData.author = author;
          if (difficulty) scriptData.level = parseInt(difficulty);
          if (minPlayers) scriptData.min_player = parseInt(minPlayers);
          if (maxPlayers) scriptData.max_player = parseInt(maxPlayers);

          // Validate required fields
          if (
            !scriptData.roles ||
            !Array.isArray(scriptData.roles) ||
            scriptData.roles.length === 0
          ) {
            showError('å‰§æœ¬å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªè§’è‰²');
            return;
          }

          // Set default name if not provided
          if (!scriptData.name) scriptData.name = 'æœªå‘½åå‰§æœ¬';

          // Send JSON data to server for storage
          const jsonString = JSON.stringify(scriptData);

          const response = await fetch('/api/store', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: jsonString,
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || 'æœåŠ¡å™¨é”™è¯¯');
          }

          const responseData = await response.json();

          generatedLink.value = responseData.url;
          result.classList.remove('error');
          result.style.display = 'block';
        } catch (error) {
          showError('ç”Ÿæˆé“¾æ¥æ—¶å‡ºé”™ï¼š' + error.message);
        }
      }

      function showError(message) {
        result.innerHTML = '<h3>é”™è¯¯ï¼š</h3><p>' + message + '</p>';
        result.classList.add('error');
        result.style.display = 'block';
      }

      async function copyLink() {
        try {
          await navigator.clipboard.writeText(
            scriptData.name ? scriptData.name + 'ï¼š' : 'å‰§æœ¬é“¾æ¥ï¼š',
            generatedLink.value,
          );
          alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        } catch (error) {
          // Fallback for older browsers
          generatedLink.select();
          document.execCommand('copy');
          alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }
      }

      function openLink() {
        window.open(generatedLink.value, '_blank');
      }

      function toggleTheme() {
        const body = document.body;
        const savedMode = localStorage.getItem('themeMode');
        const systemDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

        // Determine current effective mode
        const isCurrentlyDark = body.classList.contains('revert') ? false : systemDarkMode;

        if (isCurrentlyDark) {
          // Currently dark, switch to light
          body.classList.add('revert');
          localStorage.setItem('themeMode', 'light');
        } else {
          // Currently light, switch to dark
          body.classList.remove('revert');
          localStorage.setItem('themeMode', 'dark');
        }
      }

      // Add transition styles after initial load to prevent flash
      function addTransitions() {
        const style = document.createElement('style');
        style.textContent = `
          * {
            transition:
              background-color 0.3s ease,
              color 0.3s ease,
              border-color 0.3s ease,
              box-shadow 0.3s ease;
          }
        `;
        document.head.appendChild(style);
      }

      // Initialize theme based on localStorage or system preference
      document.addEventListener('DOMContentLoaded', function () {
        const body = document.body;
        const savedMode = localStorage.getItem('themeMode');
        const systemDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

        // If user has manually set light mode, or system is light and no preference saved
        if (savedMode === 'light' || (savedMode === null && !systemDarkMode)) {
          if (systemDarkMode) {
            body.classList.add('revert');
          }
        }
        // If user has manually set dark mode
        else if (savedMode === 'dark') {
          if (!systemDarkMode) {
            // System is light but user wants dark - we can't force dark mode
            // Just remove revert class to use system default
            body.classList.remove('revert');
          }
        }

        // Add transitions after theme is set to prevent flash
        setTimeout(addTransitions, 50);
      });
    </script>
  </body>
</html>
