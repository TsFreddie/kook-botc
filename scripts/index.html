<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å‰§æœ¬æŸ¥çœ‹å™¨ - ä¸Šä¼ </title>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'PingFang SC', 'Hiragino Sans GB',
          'Microsoft YaHei', sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #555;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
      }

      .file-input {
        border: 2px dashed #ddd;
        min-height: 60px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s;
      }
      .file-input:hover {
        border-color: #007bff;
      }
      .file-input.dragover {
        border-color: #007bff;
        background-color: #f8f9fa;
      }
      .file-summary {
        padding: 20px;
        background: #e8f5e8;
        border: 2px solid #4caf50;
        border-radius: 4px;
        min-height: 60px;
        display: flex;
        align-items: center;
      }
      .summary-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .remove-btn {
        background: #f44336;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        width: auto;
        margin: 0;
      }
      .remove-btn:hover {
        background: #d32f2f;
      }
      button {
        background: #007bff;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        width: 100%;
        margin-top: 10px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .result {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #2d2d2d;
        border-radius: 4px;
        display: none;
      }
      .result.error {
        border: 1px solid #2d2d2d;
        border-color: #87231c;
      }
      .link-container {
        display: flex;
        gap: 10px;
        margin-top: 10px;
      }
      .link-container input {
        flex: 1;
      }
      .copy-btn {
        width: auto;
        margin: 0;
        padding: 10px 15px;
      }
      .qr-container {
        display: flex;
        gap: 20px;
        margin-top: 15px;
        align-items: flex-start;
      }
      .qr-code {
        flex-shrink: 0;
      }
      .qr-code canvas {
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .row {
        display: flex;
        gap: 15px;
      }
      .row .form-group {
        flex: 1;
      }
      .theme-toggle {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        z-index: 1000;
      }
      .theme-toggle::before {
        content: 'ğŸŒ™';
      }
      .theme-toggle:hover {
        background: #e0e0e0;
      }
      @media (prefers-color-scheme: dark) {
        body {
          background-color: #1a1a1a;
          color: #e0e0e0;
        }
        .container {
          background: #2d2d2d;
          color: #e0e0e0;
        }
        h1 {
          color: #e0e0e0;
        }
        label {
          color: #ccc;
        }
        input,
        textarea,
        select {
          background: #3d3d3d;
          border-color: #555;
          color: #e0e0e0;
        }
        .file-input {
          border-color: #555;
          background: #3d3d3d;
        }
        .file-input:hover {
          border-color: #007bff;
        }
        .file-input.dragover {
          background-color: #4d4d4d;
        }
        .file-summary {
          background: #2d4a2d;
          border-color: #4caf50;
        }
        .qr-code canvas {
          border-color: #555;
        }

        .theme-toggle {
          background: #333;
          color: #e0e0e0;
          border-color: #555;
        }
        .theme-toggle::before {
          content: 'â˜€ï¸';
        }
        .theme-toggle:hover {
          background: #444;
        }
      }
      body.revert {
        background-color: #f5f5f5;
        color: black;
      }
      body.revert .container {
        background: white;
        color: black;
      }
      body.revert h1 {
        color: #333;
      }
      body.revert label {
        color: #555;
      }
      body.revert input,
      body.revert textarea,
      body.revert select {
        background: white;
        border-color: #ddd;
        color: black;
      }
      body.revert .file-input {
        border-color: #ddd;
        background: white;
      }
      body.revert .file-input.dragover {
        background-color: #f8f9fa;
      }
      body.revert .file-summary {
        background: #e8f5e8;
        border-color: #4caf50;
      }
      body.revert .qr-code canvas {
        border-color: #ddd;
      }

      body.revert .theme-toggle {
        background: #f0f0f0;
        color: black;
        border-color: #ccc;
      }
      body.revert .theme-toggle::before {
        content: 'ğŸŒ™';
      }
      body.revert .theme-toggle:hover {
        background: #e0e0e0;
      }
      .footer {
        margin-top: 2em;
        padding-top: 1em;
        border-top: 1px solid #ccc;
        font-size: 0.8em;
        color: #666;
      }
      .footer a {
        color: #0085bd;
        text-decoration: none;
      }
      .footer a:visited {
        color: #0085bd;
      }
      .footer a:hover {
        text-decoration: underline;
      }
      @media (prefers-color-scheme: dark) {
        .footer {
          border-top-color: #444;
          color: #999;
        }
      }
      body.revert .footer {
        border-top-color: #ccc;
        color: #666;
      }
    </style>
  </head>
  <body>
    <button class="theme-toggle" onclick="toggleTheme()"></button>
    <div class="container">
      <h1>ã€ŠæŸ“ãƒ»é’Ÿæ¥¼è°œå›¢ã€‹å‰§æœ¬æŸ¥çœ‹å™¨</h1>

      <form id="scriptForm">
        <div class="form-group">
          <label for="jsonFile">ä¸Šä¼  JSON æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰</label>
          <div class="file-input" id="fileInput">
            <input type="file" id="jsonFile" accept=".json" style="display: none" />
            <p>ç‚¹å‡»æ­¤å¤„æˆ–æ‹–æ‹½ JSON æ–‡ä»¶åˆ°è¿™é‡Œ</p>
          </div>
          <div class="file-summary" id="fileSummary" style="display: none">
            <div class="summary-content">
              <span id="summaryText"></span>
              <button type="button" class="remove-btn" onclick="clearData()">ç§»é™¤</button>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="scriptName">å‰§æœ¬åç§°ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="scriptName" placeholder="è¾“å…¥å‰§æœ¬åç§°" />
          </div>
          <div class="form-group">
            <label for="author">ä½œè€…ï¼ˆå¯é€‰ï¼‰</label>
            <input type="text" id="author" placeholder="è¾“å…¥ä½œè€…åç§°" />
          </div>
        </div>

        <div class="row">
          <div class="form-group">
            <label for="difficulty">éš¾åº¦ï¼ˆå¯é€‰ï¼‰</label>
            <select id="difficulty">
              <option value="">é€‰æ‹©éš¾åº¦</option>
              <option value="1">1 - â˜…â˜†â˜†â˜†â˜†</option>
              <option value="2">2 - â˜…â˜…â˜†â˜†â˜†</option>
              <option value="3">3 - â˜…â˜…â˜…â˜†â˜†</option>
              <option value="4">4 - â˜…â˜…â˜…â˜…â˜†</option>
              <option value="5">5 - â˜…â˜…â˜…â˜…â˜…</option>
            </select>
          </div>
          <div class="form-group">
            <label for="minPlayers">æœ€å°‘äººæ•°ï¼ˆå¯é€‰ï¼‰</label>
            <input type="number" id="minPlayers" min="5" max="20" placeholder="5" />
          </div>
          <div class="form-group">
            <label for="maxPlayers">æœ€å¤šäººæ•°ï¼ˆå¯é€‰ï¼‰</label>
            <input type="number" id="maxPlayers" min="5" max="20" placeholder="15" />
          </div>
        </div>

        <button type="submit">ç”Ÿæˆå‰§æœ¬é“¾æ¥</button>
      </form>

      <div id="result" class="result">
        <h3>ç”Ÿæˆçš„é“¾æ¥ï¼š</h3>
        <div class="link-container">
          <input type="text" id="generatedLink" readonly />
          <button type="button" class="copy-btn" onclick="copyLink()">å¤åˆ¶</button>
          <button type="button" class="copy-btn" onclick="openLink()">æ‰“å¼€</button>
        </div>
        <div class="qr-container">
          <div class="qr-code">
            <div id="qrcode"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="footer">
      <p>
        ç‰ˆæƒæ‰€æœ‰
        <a href="https://bloodontheclocktower.com/" target="_blank">The Pandemonium Institute</a> å’Œ
        <a href="https://clocktower.gstonegames.com/" target="_blank">é›†çŸ³</a>
      </p>
      <p>æœ¬é¡µé¢ç”±ç¬¬ä¸‰æ–¹å·¥å…·"é’Ÿå°æ¥¼"ç”Ÿæˆ</p>
    </div>

    <script src="js/qrcode.min.js"></script>
    <script>
      const fileInput = document.getElementById('jsonFile');
      const fileInputDiv = document.getElementById('fileInput');
      const result = document.getElementById('result');
      const generatedLink = document.getElementById('generatedLink');

      let currentScriptData = null;

      // File input handling
      fileInputDiv.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', handleFileSelect);

      // Drag and drop handling
      fileInputDiv.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileInputDiv.classList.add('dragover');
      });

      fileInputDiv.addEventListener('dragleave', () => {
        fileInputDiv.classList.remove('dragover');
      });

      fileInputDiv.addEventListener('drop', (e) => {
        e.preventDefault();
        fileInputDiv.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFile(files[0]);
        }
      });

      // Clipboard handling for JSON content
      document.addEventListener('paste', (e) => {
        const clipboardData = e.clipboardData || window.clipboardData;
        const pastedData = clipboardData.getData('text');

        if (pastedData.trim()) {
          try {
            const parsed = JSON.parse(pastedData);
            handleJsonData(parsed);
            e.preventDefault(); // Prevent default paste behavior
          } catch (error) {
            // Not valid JSON, ignore
          }
        }
      });

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
          handleFile(file);
        }
      }

      function handleFile(file) {
        if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
          showError('è¯·é€‰æ‹© JSON æ–‡ä»¶');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const content = e.target.result;
            const parsed = JSON.parse(content);
            handleJsonData(parsed, file.name);
          } catch (error) {
            showError('æ— æ•ˆçš„ JSON æ–‡ä»¶ï¼š' + error.message);
          }
        };
        reader.readAsText(file);
      }

      function handleJsonData(parsed, fileName = null) {
        // Check if parsed data is an array (roles only)
        if (Array.isArray(parsed)) {
          currentScriptData = {
            name: fileName ? fileName.replace(/\.[^/.]+$/, '') : '', // Remove file extension
            roles: parsed,
          };
        } else {
          currentScriptData = parsed;
        }

        // Auto-fill form fields if they exist in JSON
        if (currentScriptData.name)
          document.getElementById('scriptName').value = currentScriptData.name;
        if (currentScriptData.author)
          document.getElementById('author').value = currentScriptData.author;
        if (currentScriptData.level)
          document.getElementById('difficulty').value = currentScriptData.level;
        if (currentScriptData.min_player)
          document.getElementById('minPlayers').value = currentScriptData.min_player;
        if (currentScriptData.max_player)
          document.getElementById('maxPlayers').value = currentScriptData.max_player;

        // Show summary and hide file input
        showFileSummary();

        // Clear any previous errors
        result.style.display = 'none';
      }

      function showFileSummary() {
        const fileInput = document.getElementById('fileInput');
        const fileSummary = document.getElementById('fileSummary');
        const summaryText = document.getElementById('summaryText');

        if (currentScriptData && currentScriptData.roles) {
          const roleCount = currentScriptData.roles.length;
          summaryText.textContent = `å·²åŠ è½½ ${roleCount} ä¸ªè§’è‰²`;

          fileInput.style.display = 'none';
          fileSummary.style.display = 'block';
        }
      }

      function clearData() {
        currentScriptData = null;

        // Clear form fields
        document.getElementById('scriptName').value = '';
        document.getElementById('author').value = '';
        document.getElementById('difficulty').value = '';
        document.getElementById('minPlayers').value = '';
        document.getElementById('maxPlayers').value = '';

        // Reset file input
        document.getElementById('jsonFile').value = '';

        // Show file input, hide summary
        document.getElementById('fileInput').style.display = 'block';
        document.getElementById('fileSummary').style.display = 'none';

        // Clear any results
        result.style.display = 'none';

        // Clear QR code
        const qrContainer = document.getElementById('qrcode');
        if (qrContainer) {
          qrContainer.innerHTML = '';
        }
      }

      document.getElementById('scriptForm').addEventListener('submit', (e) => {
        e.preventDefault();
        generateLink();
      });

      async function generateLink() {
        try {
          let scriptData;

          // Check if we have script data from file/clipboard
          if (!currentScriptData) {
            showError('è¯·å…ˆä¸Šä¼  JSON æ–‡ä»¶æˆ–ç²˜è´´ JSON å†…å®¹');
            return;
          }

          // Use the current script data
          scriptData = { ...currentScriptData };

          // Override with form values if provided
          const name = document.getElementById('scriptName').value.trim();
          const author = document.getElementById('author').value.trim();
          const difficulty = document.getElementById('difficulty').value;
          const minPlayers = document.getElementById('minPlayers').value;
          const maxPlayers = document.getElementById('maxPlayers').value;

          if (name) scriptData.name = name;
          if (author) scriptData.author = author;
          if (difficulty) scriptData.level = parseInt(difficulty);
          if (minPlayers) scriptData.min_player = parseInt(minPlayers);
          if (maxPlayers) scriptData.max_player = parseInt(maxPlayers);

          // Validate required fields
          if (
            !scriptData.roles ||
            !Array.isArray(scriptData.roles) ||
            scriptData.roles.length === 0
          ) {
            showError('å‰§æœ¬å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ªè§’è‰²');
            return;
          }

          // Set default name if not provided
          if (!scriptData.name) scriptData.name = 'æœªå‘½åå‰§æœ¬';

          // Generate URL with compression support detection
          const jsonString = JSON.stringify(scriptData);

          // Check if browser supports compression streams
          if ('CompressionStream' in window) {
            try {
              // Use browser's native compression
              const stream = new CompressionStream('gzip');
              const writer = stream.writable.getWriter();
              const reader = stream.readable.getReader();

              // Write the JSON string
              writer.write(new TextEncoder().encode(jsonString));
              writer.close();

              // Read compressed data
              const chunks = [];
              let done = false;
              while (!done) {
                const { value, done: readerDone } = await reader.read();
                done = readerDone;
                if (value) chunks.push(value);
              }

              // Combine chunks and encode to base64
              const compressedSize = chunks.reduce((acc, chunk) => acc + chunk.length, 0);
              const compressed = new Uint8Array(compressedSize);
              let offset = 0;
              for (const chunk of chunks) {
                compressed.set(chunk, offset);
                offset += chunk.length;
              }

              const base64 = btoa(String.fromCharCode(...compressed))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
              const url = window.location.origin + '/z/' + base64;

              generatedLink.value = url;
              result.classList.remove('error');
              result.style.display = 'block';
              generateQRCode(url);
              return;
            } catch (compressionError) {
              console.warn('Compression failed, falling back to uncompressed:', compressionError);
            }
          }

          // Fallback to uncompressed base64 encoding
          const utf8Bytes = new TextEncoder().encode(jsonString);
          const base64 = btoa(String.fromCharCode(...utf8Bytes))
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=/g, '');
          const url = window.location.origin + '/' + base64;

          generatedLink.value = url;
          result.classList.remove('error');
          result.style.display = 'block';
          generateQRCode(url);
        } catch (error) {
          showError('ç”Ÿæˆé“¾æ¥æ—¶å‡ºé”™ï¼š' + error.message);
        }
      }

      function showError(message) {
        result.innerHTML = '<h3>é”™è¯¯ï¼š</h3><p>' + message + '</p>';
        result.classList.add('error');
        result.style.display = 'block';
      }

      async function copyLink() {
        try {
          // Copy the link text
          await navigator.clipboard.writeText(generatedLink.value);

          // Try to copy QR code as image
          const qrCanvas = document.querySelector('#qrcode canvas');
          if (qrCanvas && navigator.clipboard && navigator.clipboard.write) {
            try {
              // Convert canvas to blob
              const blob = await new Promise((resolve) => {
                qrCanvas.toBlob(resolve, 'image/png');
              });

              // Create clipboard item with both text and image
              const clipboardItem = new ClipboardItem({
                  'image/png': blob,
                'text/plain': new Blob([generatedLink.value], { type: 'text/plain' }),
              });

              await navigator.clipboard.write([clipboardItem]);
              alert('é“¾æ¥å’ŒäºŒç»´ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            } catch (imageError) {
              console.warn('Failed to copy QR code image:', imageError);
              alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }
          } else {
            alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
          }
        } catch (error) {
          // Fallback for older browsers
          generatedLink.select();
          document.execCommand('copy');
          alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
        }
      }

      function openLink() {
        window.open(generatedLink.value, '_blank');
      }

      function generateQRCode(url) {
        const qrContainer = document.getElementById('qrcode');
        qrContainer.innerHTML = ''; // Clear previous QR code

        if (typeof QRCode !== 'undefined') {
          new QRCode(qrContainer, {
            text: url,
            width: 128,
            height: 128,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.L,
          });
        } else {
          console.error('QRCode library not loaded');
        }
      }

      function toggleTheme() {
        const body = document.body;
        const savedMode = localStorage.getItem('themeMode');
        const systemDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

        // Determine current effective mode
        const isCurrentlyDark = body.classList.contains('revert') ? false : systemDarkMode;

        if (isCurrentlyDark) {
          // Currently dark, switch to light
          body.classList.add('revert');
          localStorage.setItem('themeMode', 'light');
        } else {
          // Currently light, switch to dark
          body.classList.remove('revert');
          localStorage.setItem('themeMode', 'dark');
        }
      }

      // Initialize theme based on localStorage or system preference
      document.addEventListener('DOMContentLoaded', function () {
        const body = document.body;
        const savedMode = localStorage.getItem('themeMode');
        const systemDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;

        // If user has manually set light mode, or system is light and no preference saved
        if (savedMode === 'light' || (savedMode === null && !systemDarkMode)) {
          if (systemDarkMode) {
            body.classList.add('revert');
          }
        }
        // If user has manually set dark mode
        else if (savedMode === 'dark') {
          if (!systemDarkMode) {
            // System is light but user wants dark - we can't force dark mode
            // Just remove revert class to use system default
            body.classList.remove('revert');
          }
        }
      });
    </script>
  </body>
</html>
